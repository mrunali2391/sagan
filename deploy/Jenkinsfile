pipeline {
    agent any
     triggers {
        pollSCM "* * * * *"
     }
    environment {
        GITHUB = credentials('gitHubCredentials')
        registry = "mruingle/sagan-deploy"
        registryCredential = "dockerHubCredentials"
        dockerImage = " "

    }

    stages {
        stage('Checkout') {
            steps{
                checkout scm
            }
        }
        stage('Build') {
            steps {
                        sh script:'''
                            #!/bin/bash
                            echo "This is start $(pwd)"
                            cd  ./deploy
                            ./gradlew build
                            '''
                        sh script:'''
                           #!/bin/bash
                           echo "This is start $(pwd)"
                           cd ../
                           echo "This is $(pwd)"
                           '''
            }
        }

        stage('Build Docker Image') {

                            steps {
                                echo '=== Building sagan Docker Image ==='
                                script {
                                    dockerImage = docker.build registry + ":$BUILD_NUMBER"
                                }
                            }
                }
                stage('Push Docker Image') {
                            steps {
                                echo '=== Pushing sagan Docker Image ==='
                                script {
                                  docker.withRegistry( '', registryCredential ) {
                                       dockerImage.push()
                                          }
                                        }
                            }
                }
                stage('Remove local images') {
                                             steps{
                                             sh "docker rmi $registry:$BUILD_NUMBER"
                                               }
                                                                        }
                stage('Deployment on minikube') {
                                             steps{
                                             sh "whoami"
                                             sh "scp -i aws-june-2021.pem /var/lib/jenkins/.ssh/id_rsa.pub ubuntu@172.16.10.58:/tmp"
                                             sh "ssh -i  aws-june-2021.pem ubuntu@172.16.10.144 'cat /tmp/id_rsa.pub >> ~/.ssh/authorized_keys'"

                                             sh "ssh ubuntu@172.16.10.58 'hostname'"
                                             sh "ssh ubuntu@172.16.10.58 'sudo kubectl get pod'"
                                             sh "ssh ubuntu@172.16.10.58 'sudo kubectl apply -f /root/sagan-deployment.yaml'"
                                             sh "ssh ubuntu@172.16.10.58 'sudo kubectl set image Deployment/sagan-deploy  sagan-deploy=mrunali2391/sagan-deploy:$BUILD_NUMBER --record'"
                                             sh "ssh ubuntu@172.16.10.58 'sudo kubectl get  pod,deployment,svc,secrets'"
                                               }
                                                                        }

    }
}
